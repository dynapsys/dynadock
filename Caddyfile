# Global configuration
{
    email admin@local.dev
    debug
    local_certs
}

# Health endpoint on port 80 (always plain HTTP)
:80 {
    respond /health "OK" 200
}

# API service
localhost, api.localhost {
    # Handle HTTP to HTTPS redirect
    @http {
        protocol http
    }
    redir @http https://{host}{uri} permanent

    # API reverse proxy - use plain HTTP for backend
    reverse_proxy http://api:80 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }

    log {
        output file /var/log/caddy/api.log
        format json
        level info
    }
}

# Redis service (example of a TCP service)
redis.localhost {
    reverse_proxy redis:6379 {
        transport http {
            tls_insecure_skip_verify
        }
    }
    
    log {
        output file /var/log/caddy/redis.log
        format json
        level info
    }
}

# Catch-all for undefined hosts
:443 {
    tls internal
    respond "Service not found" 404
}
